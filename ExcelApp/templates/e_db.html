{% extends "base.html" %}

{% load static %}

{% block content %}
<style>
  .modal{
    overflow-y:auto;
  }
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <!--<h1 class="h2">Base de Datos - Consultas: {{file.name}} --- Enlace: {{file.file}} </h1>-->
  <h1 class="h2">Consultas: {{file.name}}</h1>
</div>

<form method="POST" class="post-form" style="font-weight:bold" action="/excel/db/{{file.id}}">
  {% csrf_token %}  
 
  <label class="col-1 col-form-label">TRANSPORTISTA</label>
  <div class="col-md mb-2">    
    <select name="transporte" class="selectpicker form-control" data-live-search="true">
      <option selected="selected"  value="-1" data-tokens="-1"> ninguno </option>
      {% for transporte in transportes %}  
        {% if transporte.id == datos.transporte|add:0 %}       
          <option selected="selected" selected="selected" value="{{ transporte.id }}" data-tokens="{{ transporte.id }}"> {{ transporte.name }}</option>
        {% else %}
          <option value="{{ transporte.id }}" data-tokens="{{ transporte.id }}"> {{ transporte.name }} </option>
        {% endif %}
      {% endfor %}
    </select>
  </div>

  <label class="col-1 col-form-label">CONTRATISTA</label>
  <div class="col-md mb-2">    
    <select name="contratista" class="selectpicker form-control" data-live-search="true">
      <option selected="selected" value="-1" data-tokens="-1"> ninguno </option>
      {% for contratista in contratistas %}          
        {% if contratista.id == datos.contratista|add:0 %}        
          <option selected="selected" value="{{ contratista.id }}" data-tokens="{{ contratista.id }}"> {{ contratista.name }} </option>
        {% else %}
          <option value="{{ contratista.id }}" data-tokens="{{ contratista.id }}"> {{ contratista.name }} </option>
        {% endif %}
      {% endfor %}
    </select>
  </div>  
 
  <label class="col-1 col-form-label">CONDUCTOR</label>
  <div class="col-md mb-2">    
    <select name="conductor" class="selectpicker form-control" data-live-search="true">
      <option selected="selected" value="-1" data-tokens="-1"> ninguno </option>
      {% for trabajador in trabajadores %}          
        {% if trabajador.id == datos.conductor|add:0 %} 
          <option selected="selected" value="{{ trabajador.id }}" data-tokens="{{ trabajador.id }}"> {{ trabajador.name }} </option>
        {% elif trabajador.name %}
          <option value="{{ trabajador.id }}" data-tokens="{{ trabajador.id }}"> {{ trabajador.name }} </option>        
        {% endif %}
      {% endfor %}
    </select>
  </div>

  <label class="col-1 col-form-label">NÚMERO CONVOY</label>
  <div class="col-md mb-2">    
    <select name="num_convoy" class="selectpicker form-control" data-live-search="true">
      <option selected="selected" value="-1" data-tokens="-1"> ninguno </option>
      {% for num_convoy in convoys %}          
        {% if num_convoy.id == datos.num_convoy|add:0 %} 
          <option selected="selected" value="{{ num_convoy.id }}" data-tokens="{{ num_convoy.id }}"> {{ num_convoy.name }} </option>
        {% else %}
          <option value="{{ num_convoy.id }}" data-tokens="{{ num_convoy.id }}"> {{ num_convoy.name }} </option>
        {% endif %}
      {% endfor %}
    </select>
  </div>

  <label class="col-1 col-form-label">PLACA</label>
  <div class="col-md mb-2">    
    <select name="placa" class="selectpicker form-control" data-live-search="true">
      <option selected="selected" value="-1" data-tokens="-1"> ninguno </option>
      {% for placa in placas %}          
        {% if placa.id == datos.placa|add:0 %} 
          <option selected="selected" value="{{ placa.id }}" data-tokens="{{ placa.id }}"> {{ placa.placa1 }} | {{ placa.placa2 }} </option>          
        {% elif placa.placa1 %}
          <option value="{{ placa.id }}" data-tokens="{{ placa.id }}"> {{ placa.placa1 }} | {{ placa.placa2 }} </option>          
        {% endif %}
      {% endfor %}
    </select>
  </div>


  <div class="text-center">
    <button type="submit" class="btn btn-success">CONSULTAR</button>
  </div>
</form>
<br>
<form method="GET" class="post-form" action="/excel/db/{{file.id}}">
  {% csrf_token %}  

  <div class="text-center">
    <button type="submit" class="btn btn-warning">VER TODO</button>
  </div>
</form>

<table cellspacing="0" width="325%" id="dtHorizontalVerticalExample" style="background-color:#F5F5F5;">
 
  <thead class="thead-dark">
		<tr>
			<th scope="col">Ea</th>
			<th scope="col">Contratista</th>
			<th scope="col">Transportista</th>
			<th scope="col">Modalidad de Ingreso</th>
      <th scope="col">Tipo de Vehículo</th>	
      <th scope="col">Placa 1 | Placa 2</th>	
      <th scope="col">Desinfectado</th>	
      <th scope="col">CHECKLIST</th>	      
      <th scope="col">Apellidos y Nombres</th>	
      <th scope="col">Nº Licencia</th>
      <th scope="col">FATIGA</th>	
      <th scope="col">DECLARACION JURADA</th>	
      <th scope="col">IPERC</th>
      <th scope="col">Apellidos y Nombres Relevo</th>	
      <th scope="col">Nº Licencia Relevo</th>	
      <th scope="col">FATIGA RELEVO</th>	
      <th scope="col">DECLARACION JURADA RELEVO</th>	
      <th scope="col">IPERC RELEVO</th>
      <th scope="col">Placa 1 | Placa 2 Relevo</th>	
      <th scope="col">CHECKLIST RELEVO</th>	
      <th scope="col">Teléfono Escolta</th>	
      <th scope="col">Teléfono Satelital</th>	
      <th scope="col">Pasajeros</th>	
      <th scope="col">Carga</th>	
      <th scope="col">Nº Guía</th>	
      <th scope="col">Descripción</th>	
      <th scope="col">Desde</th>	
      <th scope="col">Hacia</th>	
      <th scope="col">Fecha Llegada a Checkpoint</th>	
      <th scope="col">Hora Llegada a Checkpoint</th>
      <th scope="col">Hora de Partida</th>	
      <th scope="col">Nº Convoy</th>	
      <th scope="col">ETA SITE</th>	
      <th scope="col">Estado</th>	
      <th scope="col">Motivo</th>	
      <th scope="col">Observaciones</th>	

		</tr>
	</thead>
	<tbody>
    {% for fila in tabla %}
    {% if fila.estado.name == "DESAPROBADO" %}
		  <tr class="table-danger">
    {% else %}
      <tr >
    {% endif %}

			<td>{{ fila.ea }}</td>
			<td>{{ fila.contratista.name }}</td>
			<td>{{ fila.transporte.name }}</td>
      <td>{{ fila.modalidad_ingreso.name }}</td>
      <td>{{ fila.tipo_vehiculo.name }}</td>
      <td>
        {% if fila.cantidad_desinfectado %}
          <a href="/excel/db/{{file.id}}/show_vehicle/{{fila.conductor_placa.id}}/{{fila.cantidad_desinfectado}}"><span class="glyphicon glyphicon-pencil">{{ fila.conductor_placa.placa1 }}  {{ fila.conductor_placa.placa2 }}</span></a>          
        {% else %}
        <a href="/excel/db/{{file.id}}/show_vehicle/{{fila.conductor_placa.id}}/0"><span class="glyphicon glyphicon-pencil">{{ fila.conductor_placa.placa1 }}  {{ fila.conductor_placa.placa2 }}</span></a>                    
        {% endif %}
        
      </td> 
      <td>
        <script type="text/javascript">          
          function onClick(conductor_placa_id) {
            
            var comentario = prompt("Estas seguro de agregar una desinfección? Escribe tu comentario:", "Ninguno");
            if (comentario == null || comentario == "") {
            }
            else{
              var fd = new FormData();              
              fd.append('file_id','{{file.id}}');
              fd.append('conductor_placa_id',conductor_placa_id);
              fd.append('comentario',comentario);

              // AJAX request
              $.ajax({
                headers: { "X-CSRFToken": token },
                url: '/excel/db/add_disinfect', 
                type: 'POST',
                data: fd,
                contentType: false,
                processData: false,
                success: function(response){
                  if(response != 0){
                    alert('Desinfección Actualizada');
                    resultados = response.resultado
                    location.reload()                    
                  }else{
                    alert('file not uploaded');
                  }
                }
              });
            }
          };
          </script>
          {% if fila.cantidad_desinfectado %}
            <button class = "btn btn-danger" type="button" onClick="onClick('{{fila.conductor_placa.id}}')" id="{{fila.conductor_placa.id}}">Desinfectado: {{fila.cantidad_desinfectado}}</button><br>
            Comentario: {{fila.comentario}}
          {% else %}
            <button class = "btn btn-danger" type="button" onClick="onClick('{{fila.conductor_placa.id}}')" id="{{fila.conductor_placa.id}}">Desinfectado: 0</button><br>
            Comentario: Ninguno
          {% endif %}
          
      </td> 
      {% if fila.conductor_placa.placa1 %} 
        <!--modal checklist-->
        <td>
          {% load custom_template_tags %}         
          {% setvar "true" as action4 %}
          {% for vehiculo_archivo in vehiculo_archivos %} 
            
            {% if fila.conductor_placa.id == vehiculo_archivo.placa_id %}              
              {% if vehiculo_archivo.checklist_file_encode%}
                {% setvar "false" as action4 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action4 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_cl{{fila.conductor_placa.id}}">CHECKLIST</button>
              {% else %}
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_cl{{fila.conductor_placa.id}}">CHECKLIST</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}    

          {% if not vehiculo_archivos %}
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_cl{{fila.conductor_placa.id}}">CHECKLIST</button>
          {% endif %}
          
          <!-- Modal -->
          <div id="uploadModal_cl{{fila.conductor_placa.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Arhivo CheckList : <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('check_list', 'file_cl{{fila.conductor_placa.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file_cl{{fila.conductor_placa.id}}' id='file_cl{{fila.conductor_placa.id}}_{{fila.id}}'></div>
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV4" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar_cl{{fila.conductor_placa.id}}_{{fila.id}}">
                        {% for lugar in lugares %}
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>
                        {% endfor %}
                      </select><br>   
                      Evidencia Fotográfica : <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs_cl{{fila.conductor_placa.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div name='file_obs_cl{{fila.conductor_placa.id}}' id='file_obs_cl{{fila.conductor_placa.id}}_{{fila.id}}'></div>
                      
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion_cl" id='id_modal_descripcion_cl{{fila.conductor_placa.id}}_{{fila.id}}'/><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion_cl" id="id_modal_plan_accion_cl{{fila.conductor_placa.id}}_{{fila.id}}"/><br>
                      Evidencia Levantamiento : <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev_cl{{fila.conductor_placa.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev_cl{{fila.conductor_placa.id}}' id='file_lev_cl{{fila.conductor_placa.id}}_{{fila.id}}'></div>

                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR CHECKLIST' id='btn_cl{{fila.conductor_placa.id}}_{{fila.id}}' name='{{fila.conductor_placa.id}}'>
                  </form> 
                
                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>      
      {% else %}  
        <td></td>


      {% endif %}
      <td>
        <a href="/excel/db/{{file.id}}/show_driver/{{fila.conductor.id}}"><span class="glyphicon glyphicon-pencil">{{ fila.conductor.name }}</span></a>
      </td>
      <td>{{ fila.conductor.license }}</td>

      {% if fila.conductor.name %}
        <!--modal fatiga-->
        <td>
          {% load custom_template_tags %}         
          {% setvar "true" as action1 %}
          {% for conductor_archivo in conductor_archivos %} 
            
            {% if fila.conductor.id == conductor_archivo.conductor_id %}              
              {% if conductor_archivo.fatiga_file_encode%}
                {% setvar "false" as action1 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action1 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal{{fila.conductor.id}}">FATIGA</button>
              {% else %}
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal{{fila.conductor.id}}">FATIGA</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}    

          {% if not conductor_archivos %}
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal{{fila.conductor.id}}">FATIGA</button>
          {% endif %}
          
          <!-- Modal -->
          <div id="uploadModal{{fila.conductor.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Arhivo Fatiga : 
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('fatiga', 'file{{fila.conductor.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file{{fila.conductor.id}}' id='file{{fila.conductor.id}}_{{fila.id}}'></div>
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar{{fila.conductor.id}}_{{fila.id}}">
                        {% for lugar in lugares %}                          
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>                          
                        {% endfor %}
                      </select><br>
                      Evidencia Fotográfica : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs{{fila.conductor.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div  name='file_obs{{fila.conductor.id}}' id='file_obs{{fila.conductor.id}}_{{fila.id}}'></div>                                            
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion" id='id_modal_descripcion{{fila.conductor.id}}_{{fila.id}}' /><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion" id="id_modal_plan_accion{{fila.conductor.id}}_{{fila.id}}" /><br>
                      Evidencia Levantamiento : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev{{fila.conductor.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev{{fila.conductor.id}}' id='file_lev{{fila.conductor.id}}_{{fila.id}}'></div>                      
                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR FATIGA' id='btn_upload{{fila.conductor.id}}_{{fila.id}}' name='{{fila.conductor.id}}'>
                  </form> 
                
                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>
              
        <!--modal declaracion jurada-->
        <td>

          {% setvar "true" as action2 %}
          {% for conductor_archivo in conductor_archivos %} 
            
            {% if fila.conductor.id == conductor_archivo.conductor_id %}              
              {% if conductor_archivo.declaracion_file_encode%}
                {% setvar "false" as action2 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action2 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_dj{{fila.conductor.id}}">DECLARACION</button>
              {% else %}
                <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_dj{{fila.conductor.id}}">DECLARACION</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}

          {% if not conductor_archivos %}
            <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_dj{{fila.conductor.id}}">DECLARACION</button>
          {% endif %}

          <!-- Modal -->
          <div id="uploadModal_dj{{fila.conductor.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Arhivo Declaración Jurada : 
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('declaracion', 'file_dj{{fila.conductor.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file_dj{{fila.conductor.id}}' id='file_dj{{fila.conductor.id}}_{{fila.id}}'></div>                    
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV2" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar_dj{{fila.conductor.id}}_{{fila.id}}">
                        {% for lugar in lugares %}
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>
                        {% endfor %}
                      </select><br>
                      Evidencia Fotográfica :
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs_dj{{fila.conductor.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div name='file_obs_dj{{fila.conductor.id}}' id='file_obs_dj{{fila.conductor.id}}_{{fila.id}}'></div>                      
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion" id='id_modal_descripcion_dj{{fila.conductor.id}}_{{fila.id}}' /><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion" id="id_modal_plan_accion_dj{{fila.conductor.id}}_{{fila.id}}" /><br>
                      Evidencia Levantamiento :
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev_dj{{fila.conductor.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev_dj{{fila.conductor.id}}' id='file_lev_dj{{fila.conductor.id}}_{{fila.id}}'></div>                      
                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR DECLARACION' id='btn_dj{{fila.conductor.id}}_{{fila.id}}' name='{{fila.conductor.id}}'>
                  </form>                   
                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>

        <!--modal iperc-->
        <td>

          {% setvar "true" as action3 %}
          {% for conductor_archivo in conductor_archivos %} 
            
            {% if fila.conductor.id == conductor_archivo.conductor_id %}              
              {% if conductor_archivo.iperc_file_encode%}
                {% setvar "false" as action3 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action3 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_i{{fila.conductor.id}}">IPERC</button>
              {% else %}
                <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_i{{fila.conductor.id}}">IPERC</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}

          {% if not conductor_archivos %}
            <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_i{{fila.conductor.id}}">IPERC</button>
          {% endif %}

          <!-- Modal -->
          <div id="uploadModal_i{{fila.conductor.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Archivo Iperc : 
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('iperc', 'file_i{{fila.conductor.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file_i{{fila.conductor.id}}' id='file_i{{fila.conductor.id}}_{{fila.id}}'></div>                    
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV3" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar_i{{fila.conductor.id}}_{{fila.id}}">
                        {% for lugar in lugares %}
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>
                        {% endfor %}
                      </select><br>
                      Evidencia Fotográfica : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs_i{{fila.conductor.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div name='file_obs_i{{fila.conductor.id}}' id='file_obs_i{{fila.conductor.id}}_{{fila.id}}'></div>                      
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion" id='id_modal_descripcion_i{{fila.conductor.id}}_{{fila.id}}' /><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion" id="id_modal_plan_accion_i{{fila.conductor.id}}_{{fila.id}}" /><br>
                      Evidencia Levantamiento : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev_i{{fila.conductor.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev_i{{fila.conductor.id}}' id='file_lev_i{{fila.conductor.id}}_{{fila.id}}'></div>                                         
                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR IPERC' id='btn_i{{fila.conductor.id}}_{{fila.id}}' name='{{fila.conductor.id}}'>
                  </form> 

                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>
        
        {% else %}  
        <td></td><td></td><td></td>
      {% endif %}
      <td>
        <a href="/excel/db/{{file.id}}/show_driver/{{fila.conductor_relevo.id}}"><span class="glyphicon glyphicon-pencil">{{ fila.conductor_relevo.name }}</span></a>
      </td>      
      <td>{{ fila.conductor_relevo.license }}</td>

      {% if fila.conductor_relevo.name %}
        <!--modal fatiga-->
        <td>
          {% load custom_template_tags %}         
          {% setvar "true" as action1 %}
          {% for conductor_archivo in conductor_archivos %} 
            
            {% if fila.conductor_relevo.id == conductor_archivo.conductor_id %}              
              {% if conductor_archivo.fatiga_file_encode%}
                {% setvar "false" as action1 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action1 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal{{fila.conductor_relevo.id}}">FATIGA</button>
              {% else %}
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal{{fila.conductor_relevo.id}}">FATIGA</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}    

          {% if not conductor_archivos %}
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal{{fila.conductor_relevo.id}}">FATIGA</button>
          {% endif %}
          
          <!-- Modal -->
          <div id="uploadModal{{fila.conductor_relevo.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Arhivo Fatiga : 
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('fatiga', 'file{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file{{fila.conductor_relevo.id}}' id='file{{fila.conductor_relevo.id}}_{{fila.id}}'></div>                                        
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar{{fila.conductor_relevo.id}}_{{fila.id}}">
                        {% for lugar in lugares %}
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>
                        {% endfor %}
                      </select><br>
                      Evidencia Fotográfica : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div name='file_obs{{fila.conductor_relevo.id}}' id='file_obs{{fila.conductor_relevo.id}}_{{fila.id}}' ></div>
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion" id='id_modal_descripcion{{fila.conductor_relevo.id}}_{{fila.id}}' /><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion" id="id_modal_plan_accion{{fila.conductor_relevo.id}}_{{fila.id}}" /><br>
                      Evidencia Levantamiento : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev{{fila.conductor_relevo.id}}' id='file_lev{{fila.conductor_relevo.id}}_{{fila.id}}'></div>
                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR FATIGA' id='btn_upload{{fila.conductor_relevo.id}}_{{fila.id}}' name='{{fila.conductor_relevo.id}}'>
                  </form> 
                
                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>
              
        <!--modal declaracion jurada-->
        <td>

          {% setvar "true" as action2 %}
          {% for conductor_archivo in conductor_archivos %} 
            
            {% if fila.conductor_relevo.id == conductor_archivo.conductor_id %}              
              {% if conductor_archivo.declaracion_file_encode%}
                {% setvar "false" as action2 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action2 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_dj{{fila.conductor_relevo.id}}">DECLARACION</button>
              {% else %}
                <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_dj{{fila.conductor_relevo.id}}">DECLARACION</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}

          {% if not conductor_archivos %}
            <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_dj{{fila.conductor_relevo.id}}">DECLARACION</button>
          {% endif %}

          <!-- Modal -->
          <div id="uploadModal_dj{{fila.conductor_relevo.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Arhivo Declaración Jurada : 
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('declaracion', 'file_dj{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file_dj{{fila.conductor_relevo.id}}' id='file_dj{{fila.conductor_relevo.id}}_{{fila.id}}'></div>
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV2" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar_dj{{fila.conductor_relevo.id}}_{{fila.id}}">
                        {% for lugar in lugares %}
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>
                        {% endfor %}
                      </select><br>
                      Evidencia Fotográfica : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs_dj{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div name='file_obs_dj{{fila.conductor_relevo.id}}' id='file_obs_dj{{fila.conductor_relevo.id}}_{{fila.id}}'></div>
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion" id='id_modal_descripcion_dj{{fila.conductor_relevo.id}}_{{fila.id}}' /><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion" id="id_modal_plan_accion_dj{{fila.conductor_relevo.id}}_{{fila.id}}" /><br>
                      Evidencia Levantamiento : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev_dj{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev_dj{{fila.conductor_relevo.id}}' id='file_lev_dj{{fila.conductor_relevo.id}}_{{fila.id}}'></div>
                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR DECLARACION' id='btn_dj{{fila.conductor_relevo.id}}_{{fila.id}}' name='{{fila.conductor_relevo.id}}'>
                  </form>                   
                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>

        <!--modal iperc-->
        <td>

          {% setvar "true" as action3 %}
          {% for conductor_archivo in conductor_archivos %} 
            
            {% if fila.conductor_relevo.id == conductor_archivo.conductor_id %}              
              {% if conductor_archivo.iperc_file_encode%}
                {% setvar "false" as action3 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action3 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_i{{fila.conductor_relevo.id}}">IPERC</button>
              {% else %}
                <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_i{{fila.conductor_relevo.id}}">IPERC</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}

          {% if not conductor_archivos %}
            <button  type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_i{{fila.conductor_relevo.id}}">IPERC</button>
          {% endif %}

          <!-- Modal -->
          <div id="uploadModal_i{{fila.conductor_relevo.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Archivo Iperc : 
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('iperc', 'file_i{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file_i{{fila.conductor_relevo.id}}' id='file_i{{fila.conductor_relevo.id}}_{{fila.id}}'></div>
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV3" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar_i{{fila.conductor_relevo.id}}_{{fila.id}}">
                        {% for lugar in lugares %}
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>
                        {% endfor %}
                      </select><br>
                      Evidencia Fotográfica :
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs_i{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div name='file_obs_i{{fila.conductor_relevo.id}}' id='file_obs_i{{fila.conductor_relevo.id}}_{{fila.id}}'></div>
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion" id='id_modal_descripcion_i{{fila.conductor_relevo.id}}_{{fila.id}}' /><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion" id="id_modal_plan_accion_i{{fila.conductor_relevo.id}}_{{fila.id}}" /><br>
                      Evidencia Levantamiento : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev_i{{fila.conductor_relevo.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev_i{{fila.conductor_relevo.id}}' id='file_lev_i{{fila.conductor_relevo.id}}_{{fila.id}}'></div>
                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR IPERC' id='btn_i{{fila.conductor_relevo.id}}_{{fila.id}}' name='{{fila.conductor_relevo.id}}'>
                  </form> 

                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>

        
        {% else %}  
        <td></td><td></td><td></td>
      {% endif %}
      
      <td>
        <a href="/excel/db/{{file.id}}/show_vehicle/{{fila.conductor_relevo_placa.id}}"><span class="glyphicon glyphicon-pencil">{{ fila.conductor_relevo_placa.placa1 }}  {{ fila.conductor_relevo_placa.placa2 }}</span></a>
      </td> 
      {% if fila.conductor_relevo_placa.placa1 %} 
        <!--modal checklist-->
        <td>
          {% load custom_template_tags %}         
          {% setvar "true" as action4 %}
          {% for vehiculo_archivo in vehiculo_archivos %} 
            
            {% if fila.conductor_relevo_placa.id == vehiculo_archivo.placa_id %}              
              {% if vehiculo_archivo.checklist_file_encode%}
                {% setvar "false" as action4 %}
              {% endif %}                   
            {% endif %}

            {% if forloop.last %} 
              {% if action4 == "false" %}
                <button disabled type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_cl{{fila.conductor_relevo_placa.id}}">CHECKLIST</button>
              {% else %}
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_cl{{fila.conductor_relevo_placa.id}}">CHECKLIST</button>
              {% endif %}
            {% endif %}
            
          {% endfor %}    

          {% if not vehiculo_archivos %}
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#uploadModal_cl{{fila.conductor_relevo_placa.id}}">CHECKLIST</button>
          {% endif %}
          
          <!-- Modal -->
          <div id="uploadModal_cl{{fila.conductor_relevo_placa.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog">

              <!-- Modal content-->
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">CERRAR</h4>
                </div>
                <div class="modal-body">
                  <!-- Form -->
                  
                  <form method = "post" action='' enctype="multipart/form-data">
                    {% csrf_token %}
                    Arhivo CheckList : 
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('check_list', 'file_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}')" >Tomar Foto</button><br><br>
                    <div name='file_cl{{fila.conductor_relevo_placa.id}}' id='file_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}'></div>                                       
                    <button type="button" onclick="myFunction()" class="btn btn-danger">Añadir Observacion</button>
                    <!--Ocultar Observaciones-->
                    <div id="myDIV4" style="display:none;"><br>
                      Lugar :
                      <select class="form-control" name="lugar" id="id_lugar_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}">
                        {% for lugar in lugares %}
                            <option value="{{ lugar.id }}"> {{ lugar.name }} </option>
                        {% endfor %}
                      </select><br>
                      Evidencia Fotográfica : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia', 'file_obs_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}')" >Tomar Evidencia</button><br>
                      <div name='file_obs_cl{{fila.conductor_relevo_placa.id}}' id='file_obs_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}'></div>
                      Descripcción: <input type="text"  class="form-control" name="modal_descripcion_cl" id='id_modal_descripcion_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}'/><br>
                      Plan de accion: <input type="text"  class="form-control" name="modal_plan_accion_cl" id="id_modal_plan_accion_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}"/><br>
                      Evidencia Levantamiento : 
                      <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModalCamera" onClick="accept_camera('evidencia_correctiva', 'file_lev_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}')" >Tomar Evidencia Correctiva</button><br><br>
                      <div name='file_lev_cl{{fila.conductor_relevo_placa.id}}' id='file_lev_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}'></div>
                    </div>
                    <input type='button' class='btn btn-info' value='SUBIR CHECKLIST' id='btn_cl{{fila.conductor_relevo_placa.id}}_{{fila.id}}' name='{{fila.conductor_relevo_placa.id}}'>
                  </form> 
                
                  <!-- Preview-->
                  <div id='preview'></div>
                </div>          
              </div>
            </div>
          </div>
        </td>   
      {% else %}  
        <td></td>
      {% endif %}

      <td>{{ fila.telefono_escolta }}</td>
      <td>{{ fila.telefono_satelital }}</td>
      <td>{{ fila.pasajeros }}</td>
      <td>{{ fila.carga.name }}</td>
      <td>{{ fila.num_guia }}</td>
      <td>{{ fila.descripcion }}</td>
      <td>{{ fila.desde.name }}</td>
      <td>{{ fila.hacia.name }}</td>
      <td>{{ fila.fecha_llegada }}</td>
      <td>{{ fila.hora_llegada }}</td>
      <td>{{ fila.hora_partida }}</td>
      <td>{{ fila.num_convoy.name }}</td>
      <td>{{ fila.eta_site }}</td>
      <td>{{ fila.estado.name }}</td>
      <td>{{ fila.motivo.name }}</td>
      <td>         
        <a class="btn btn-info" href="/excel/db/{{file.id}}/obs/{{fila.id}}"><span class="glyphicon glyphicon-pencil">OBSERVACIONES</span></a>
      </td>
			
		</tr>
		{% endfor %}
	</tbody>
</table>

</br>
<!-- Paginacion -->
<div class="float-right">
  {% if tabla.has_previous %}
    <a class="btn btn-outline-info mb-4" href="?page={{ tabla.previous_page_number }}">« Página Anterior</a>
    {% if tabla.number > 3 %}
      <a class="btn btn-outline-info mb-4" href="?page=1">1</a>
      {% if tabla.number > 4 %}
        <button class="btn btn-outline-info mb-4" disabled="">...</button>
      {% endif %}
    {% endif %}
  {% endif %}

  {% for num in tabla.paginator.page_range %}
    {% if tabla.number == num %}
      <a class="btn btn-info mb-4" href="?page={{ num }}">{{ num }}</a>
    {% elif num > tabla.number|add:'-3' and num < tabla.number|add:'3' %}
      <a class="btn btn-outline-info mb-4" href="?page={{ num }}">{{ num }}</a>
    {% endif %}
  {% endfor %}

  {% if tabla.has_next %}
    {% if tabla.number < tabla.paginator.num_pages|add:'-3' %}
      <button class="btn btn-outline-info mb-4" disabled="">...</button>
      <a class="btn btn-outline-info mb-4" href="?page={{ tabla.paginator.num_pages }}">{{ tabla.paginator.num_pages }}</a>
    {% elif tabla.number < tabla.paginator.num_pages|add:'-2' %}
      <a class="btn btn-outline-info mb-4" href="?page={{ tabla.paginator.num_pages }}">{{ tabla.paginator.num_pages }}</a>
    {% endif %}
    <a class="btn btn-outline-info mb-4" href="?page={{ tabla.next_page_number }}">Página Siguiente »</a>
  {% endif %}
</div>

<!--Modal para ver la camara-->
<div class="modal" id="myModalCamera" data-backdrop="static">
	<div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">          
          <button type="button" class="btn btn-danger" value="Take Snapshot" onClick="take_snapshot()">Tomar Foto</button>         
          
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onClick="close_snapshot()">×</button>
        </div><div class="container"></div>
        <div class="modal-body">          

          <style>
            #my_camera{
            width: 640px;
            height: 480px;
            border: 1px solid black;
            }
          </style>
          <!--cargar script para redimensionar camara-->
          <script src="{% static '/js/check_device_camera.js' %}"></script>

          <div id="my_camera"></div>
          
          <div style="display: none;" id="results" >
            <div class="modal-body mi-contenido">
              <button class="btn btn-danger active mi-boton" id="save2" type="button"> Guardar </button></br></br>
              <a onclick="dibujar2()" class="btn btn-primary active mi-boton" id="dibujar_boton2" >Dibujar</a></br></br>
              <a class="btn btn-primary active mi-boton" id="dibujar_boton4" style="display: none;">A mano</a>
            </div>
            <div>
              <canvas class="canvas-content" id="canvas2" width="640" height="480"></canvas>
            </div> 
          </div>

          <!-- Webcam.min.js -->
          <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
          
          <!-- Configure a few settings and attach camera -->
          <script>  
            var camara_evidencia = null; 
            var tipo_evidencia = null;
            var id_obs = -1, id_fila;
            var my_camera = document.getElementById('my_camera');
            var results = document.getElementById('results');
            function accept_camera(tipo_evidencia, id_fila) {            
                this.tipo_evidencia = tipo_evidencia;
                this.id_fila = id_fila;
                if(tipo_evidencia == "evidencia")
                  evidencia_flag = true;
                if(tipo_evidencia == "evidencia_correctiva")
                  correctiva_flag = true;
                if(tipo_evidencia == "check_list")
                  check_list_flag = true;
                if(tipo_evidencia == "fatiga")
                  fatiga_flag = true;
                if(tipo_evidencia == "declaracion")
                  declaracion_flag = true;
                if(tipo_evidencia == "iperc")
                  iperc_flag = true;           
                Webcam.set({
                width: camera_width,
                height: camera_height,
                image_format: 'jpeg',
                jpeg_quality: 90,
                constraints: {
                  video: true,
                  facingMode: "environment"
                }
              });
              Webcam.attach(my_camera);  
            }            
            
            function take_snapshot() {
              Webcam.snap( function(data_uri) {
                camara_evidencia = data_uri;  
              });

              Webcam.reset();

              var image_path = camara_evidencia;              
              
              const canvas = document.getElementById('canvas2');
              const saveButton = document.getElementById('save2');
              const loadInput = results;
              //console.log(id_obs);
              new Drawing(canvas, saveButton, loadInput, image_path, id_obs, tipo_evidencia, id_fila);

              my_camera.style.display = "none";
              loadInput.style.display = "block";
            }

            function close_snapshot() {
              evidencia_flag = false;
              correctiva_flag = false;
              check_list_flag = false;
              fatiga_flag = false;
              declaracion_flag = false;
              iperc_flag = false;
              my_camera.style.display = "block";
              results.style.display = "none";
              circles = [];
              Webcam.reset(); 
            }

            function reset_snapshot() {
              my_camera.style.display = "block";
              results.style.display = "none";
              circles = [];
              Webcam.attach(my_camera);
            }
            
          </script>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal" onClick="close_snapshot()">Cerrar</button>
          <button type="button" class="btn btn-warning" onClick="reset_snapshot()">Regresar</button>
        </div>
      </div>
    </div>
</div>

<!--Modal de circulo que procesa-->
<div class="modal" id="myModal2" data-backdrop="static">
	<div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">PROCESANDO...</h4>
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        </div><div class="container"></div>
        <div class="modal-body">
          <link href="{% static '/css/modal_gift.css' %}" rel="stylesheet">
          <div class="show_loader" id="id_show_loader">            
            <div class="loader">    
          </div>
        </div>
      </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="{% static '/resource_template/bigtable.js' %}"></script>
  <link rel="stylesheet" type="text/css" src="{% static '/resource_template/bigtable.css' %}"/>

  <!--Script para mostrar contenido-->
  <script>
  function myFunction() {
    //var x = document.getElementById("myDIV");
    polls = document.querySelectorAll('[id ^= "myDIV"]');
    Array.prototype.forEach.call(polls, callback);

    function callback(element, iterator) {
      //console.log(iterator, element.id);
      if (element.style.display === "none") {
        element.style.display = "block";
      } else {
        element.style.display = "none";
      }
    }
   
  }
  </script>

  <!--Script para fatiga-->
  <script>
    var token = '{{csrf_token}}';
    
    $(document).ready(function(){
      $('[id^=btn_upload]').click(function(){
        var $this =  $(this).attr('name');
        var indice = $this;
        var indice_fila = $(this).attr('id');
        //console.log(indice);

        indice_fila = indice_fila.substring(indice_fila.lastIndexOf("_")+1, indice_fila.length);
        //console.log(indice_fila);
        

        var fd = new FormData();
        var files = $('#file'+indice+'_'+indice_fila)[0].files[0];
        var file_obs = $('#file_obs'+indice+'_'+indice_fila)[0].files[0];
        var id_mod_des = $('#id_modal_descripcion'+indice+'_'+indice_fila)[0].value;
        var id_plan_accion = $('#id_modal_plan_accion'+indice+'_'+indice_fila)[0].value;
        var file_lev = $('#file_lev'+indice+'_'+indice_fila)[0].files[0]; 
        var id_lugar = $('#id_lugar'+indice+'_'+indice_fila)[0].value;       

        //console.log(files);
        //console.log(id_mod_des);
        fd.append('file',files);
        fd.append('file_obs',file_obs);
        fd.append('id_mod_des',id_mod_des);
        fd.append('id_plan_accion',id_plan_accion);
        fd.append('file_lev',file_lev);        
        fd.append('fecha',"{{file.created_at|date:'c'}}");
        fd.append('lugar',id_lugar);
        $("#myModal2").modal();
        // AJAX request
        $.ajax({
          headers: { "X-CSRFToken": token },
          url: '/excel/db/'+indice+'/fatiga_modal/'+indice_fila,          
          type: 'POST',
          data: fd,
          contentType: false,
          processData: false,
          success: function(response){
            if(response != 0){
              resultados = response.resultado
              console.log(resultados);
              location.reload()
              // Show image preview
              //$('#preview').append("<img src='"+response+"' width='100' height='100' style='display: inline-block;'>");
            }else{
              alert('file not uploaded');
            }
          }
        });
      });
    });

  </script>
  
  <!--Script para declaracion jurada-->
  <script>
    var token = '{{csrf_token}}';
    
    $(document).ready(function(){
      $('[id^=btn_dj]').click(function(){
        var $this =  $(this).attr('name');
        var indice = $this;
        var indice_fila = $(this).attr('id');  

        indice_fila = indice_fila.substring(indice_fila.lastIndexOf("_")+1, indice_fila.length);      

        var fd = new FormData();        
        var files = $('#file_dj'+indice+'_'+indice_fila)[0].files[0];
        var file_obs = $('#file_obs_dj'+indice+'_'+indice_fila)[0].files[0];
        var id_mod_des = $('#id_modal_descripcion_dj'+indice+'_'+indice_fila)[0].value;
        var id_plan_accion = $('#id_modal_plan_accion_dj'+indice+'_'+indice_fila)[0].value;
        var file_lev = $('#file_lev_dj'+indice+'_'+indice_fila)[0].files[0]; 
        var id_lugar = $('#id_lugar_dj'+indice+'_'+indice_fila)[0].value;       

        fd.append('file',files);
        fd.append('file_obs',file_obs);
        fd.append('id_mod_des',id_mod_des);
        fd.append('id_plan_accion',id_plan_accion);
        fd.append('file_lev',file_lev); 
        fd.append('fecha',"{{file.created_at|date:'c'}}");
        fd.append('lugar',id_lugar);
        $("#myModal2").modal();
        // AJAX request
        $.ajax({
          headers: { "X-CSRFToken": token },
          url: '/excel/db/'+indice+'/declaracion_modal/'+indice_fila,     
          type: 'POST',
          data: fd,
          contentType: false,
          processData: false,
          success: function(response){
            if(response != 0){
              resultados = response.resultado
              console.log(resultados);
              location.reload()
              // Show image preview
              //$('#preview').append("<img src='"+response+"' width='100' height='100' style='display: inline-block;'>");
            }else{
              alert('file not uploaded');
            }
          }
        });
      });
    });

  </script>

  <!--Script para iperce-->
  <script>
    var token = '{{csrf_token}}';
    
    $(document).ready(function(){
      $('[id^=btn_i]').click(function(){
        var $this =  $(this).attr('name');
        var indice = $this;
        var indice_fila = $(this).attr('id');  

        indice_fila = indice_fila.substring(indice_fila.lastIndexOf("_")+1, indice_fila.length);   

        var fd = new FormData();
        var files = $('#file_i'+indice+'_'+indice_fila)[0].files[0];
        var file_obs = $('#file_obs_i'+indice+'_'+indice_fila)[0].files[0];
        var id_mod_des = $('#id_modal_descripcion_i'+indice+'_'+indice_fila)[0].value;
        var id_plan_accion = $('#id_modal_plan_accion_i'+indice+'_'+indice_fila)[0].value;
        var file_lev = $('#file_lev_i'+indice+'_'+indice_fila)[0].files[0]; 
        var id_lugar = $('#id_lugar_i'+indice+'_'+indice_fila)[0].value;       

        fd.append('file',files);
        fd.append('file_obs',file_obs);
        fd.append('id_mod_des',id_mod_des);
        fd.append('id_plan_accion',id_plan_accion);
        fd.append('file_lev',file_lev); 
        fd.append('fecha',"{{file.created_at|date:'c'}}");
        fd.append('lugar',id_lugar);
        $("#myModal2").modal();
        // AJAX request
        $.ajax({
          headers: { "X-CSRFToken": token },
          url: '/excel/db/'+indice+'/iperc_modal/'+indice_fila,          
          type: 'POST',
          data: fd,
          contentType: false,
          processData: false,
          success: function(response){
            if(response != 0){
              resultados = response.resultado
              console.log(resultados);
              location.reload()
              // Show image preview
              //$('#preview').append("<img src='"+response+"' width='100' height='100' style='display: inline-block;'>");
            }else{
              alert('file not uploaded');
            }
          }
        });
      });
    });

  </script>

  <!--Script para CheckList-->
  <script>
    var token = '{{csrf_token}}';
    
    $(document).ready(function(){
      $('[id^=btn_cl]').click(function(){
        var $this =  $(this).attr('name');
        var indice = $this;
        var indice_fila = $(this).attr('id');  

        indice_fila = indice_fila.substring(indice_fila.lastIndexOf("_")+1, indice_fila.length);   
        
        var fd = new FormData();
        var files = $('#file_cl'+indice+'_'+indice_fila)[0].files[0];
        var file_obs = $('#file_obs_cl'+indice+'_'+indice_fila)[0].files[0];
        var id_mod_des = $('#id_modal_descripcion_cl'+indice+'_'+indice_fila)[0].value;
        var id_plan_accion = $('#id_modal_plan_accion_cl'+indice+'_'+indice_fila)[0].value;
        var file_lev = $('#file_lev_cl'+indice+'_'+indice_fila)[0].files[0];        
        var id_lugar = $('#id_lugar_cl'+indice+'_'+indice_fila)[0].value;

        fd.append('file',files);
        fd.append('file_obs',file_obs);
        fd.append('id_mod_des',id_mod_des);
        fd.append('id_plan_accion',id_plan_accion);
        fd.append('file_lev',file_lev); 
        fd.append('fecha',"{{file.created_at|date:'c'}}");
        fd.append('lugar',id_lugar);
        $("#myModal2").modal();
        // AJAX request
        $.ajax({
          headers: { "X-CSRFToken": token },
          url: '/excel/db/'+indice+'/checklist_modal/'+indice_fila,          
          type: 'POST',
          data: fd,
          contentType: false,
          processData: false,
          success: function(response){
            if(response != 0){
              resultados = response.resultado
              console.log(resultados);
              location.reload()
              // Show image preview
              //$('#preview').append("<img src='"+response+"' width='100' height='100' style='display: inline-block;'>");
            }else{
              alert('file not uploaded');
            }
          }
        });
      });
    });

  </script>
<!--Script para habilitar el dibujar-->
<script>
  var cont = -1, cont2 = -1, cont3 = -1, cont4 = -1;
  var puede_dibujar = false;
  var puede_dibujar_a_mano = false;
  function dibujar() {
    var boton = document.getElementById("dibujar_boton1");
    var boton3 = document.getElementById("dibujar_boton3");
    cont++;
    if(cont %2 == 0){
      boton.firstChild.data  = "Dibujando";
      boton.className = "btn btn-warning active mi-boton";
      puede_dibujar = true;      
      boton3.style.display = "block";
      boton3.onclick = function() {
        cont3++;
        if(cont3 %2 == 0){          
          boton3.className = "btn btn-warning active mi-boton";
          puede_dibujar_a_mano = true;
        }
        else{          
          boton3.className = "btn btn-primary active mi-boton";
          puede_dibujar_a_mano = false;
        }
      };
      //console.log(cont);
    }else{
      boton.firstChild.data  = "Dibujar";
      boton.className = "btn btn-primary active mi-boton";
      puede_dibujar = false;
      boton3.className = "btn btn-primary active mi-boton";      
      boton3.style.display = "none";
      puede_dibujar_a_mano = false; 
      cont3 = -1;     
      //console.log(cont);
    }
  }

  function dibujar2() {
    var boton2 = document.getElementById("dibujar_boton2");
    var boton4 = document.getElementById("dibujar_boton4");
    cont2++;
    if(cont2 %2 == 0){
      boton2.firstChild.data  = "Dibujando";
      boton2.className = "btn btn-warning active mi-boton";
      puede_dibujar = true;
      boton4.style.display = "block";
      boton4.onclick = function() {
        cont4++;
        if(cont4 %2 == 0){          
          boton4.className = "btn btn-warning active mi-boton";
          puede_dibujar_a_mano = true;
        }
        else{          
          boton4.className = "btn btn-primary active mi-boton";
          puede_dibujar_a_mano = false;
        }
      };
    }else{
      boton2.firstChild.data  = "Dibujar";
      boton2.className = "btn btn-primary active mi-boton";
      puede_dibujar = false;
      boton4.className = "btn btn-primary active mi-boton";      
      boton4.style.display = "none";
      puede_dibujar_a_mano = false; 
      cont4 = -1;  
    }
  }
</script>

<!--Script para Dibujar-->
<script>
  var token = '{{csrf_token}}';
  var evidencia_src = "undefined", correctiva_src = "undefined", check_list_src = "undefined", fatiga_src = "undefined", declaracion_src = "undefined", iperc_src = "undefined";
  var evidencia_flag = true, correctiva_flag = true, check_list_flag = true, fatiga_flag= true, declaracion_flag = true, iperc_flag=true;
  var rect, offsetLeft, offsetTop, img;
  var dragging = false;
  var lastX, startX, startY, circle, radius, context_circle;
  var circles = [];
  var marginLeft = 150;
  var control = 0;
  
  class Drawing {
    constructor(canvas, saveButton, loadInput, image_path, id_obs, tipo_evidencia, id_fila) {  
      this.isDrawing = false;
      canvas.style.marginLeft = marginLeft + "px";

      //numero del canvas, 1 editar, 2 camara
      var canvas_num = canvas.id.substring(6,7);     

      canvas.addEventListener('mousedown', () => this.startDrawing());
      canvas.addEventListener('mousemove', (event) => this.draw(event, canvas_num, image_path));
      canvas.addEventListener('mouseup', () => this.stopDrawing());
      
      canvas.addEventListener('mousedown', function(e) {
        if(puede_dibujar == false){
          var evt = e || event;        
          dragging = true;
          lastX = evt.clientX;
          e.preventDefault();
        }
      }, false);

      window.addEventListener('mousemove', function(e) {
        var evt = e || event;
        if (dragging) {
          var delta = evt.clientX - lastX;
          lastX = evt.clientX;
          marginLeft += delta;
          canvas.style.marginLeft = marginLeft + "px";
        }
        e.preventDefault();
      }, false);

      window.addEventListener('mouseup', function() {
          dragging = false;
      }, false);


      // Set up touch events for mobile, etc
      canvas.addEventListener("touchstart", function (e) {
        if(puede_dibujar == true){
          var evt = e || event;        
          dragging = true;
          lastX = evt.clientX;
          e.preventDefault();
        
          var mousePos = getTouchPos(canvas, e);
          var touch = e.touches[0];
          var mouseEvent = new MouseEvent("mousedown", { 
            clientX: touch.clientX, clientY: touch.clientY,        
            });
          canvas.dispatchEvent(mouseEvent);
        }
      }, false);
      
      canvas.addEventListener("touchend", function (e) {
          var mouseEvent = new MouseEvent("mouseup", {});
          canvas.dispatchEvent(mouseEvent);
      }, false);

      canvas.addEventListener("touchmove", function (e) {
      var touch = e.touches[0];
      var mouseEvent = new MouseEvent("mousemove", {
          clientX: touch.clientX,
          clientY: touch.clientY
        });      
      canvas.dispatchEvent(mouseEvent);
      }, false);

      // Get the position of a touch relative to the canvas
      function getTouchPos(canvasDom, touchEvent) {
      var rect = canvasDom.getBoundingClientRect();
        return {
            x: touchEvent.touches[0].clientX - rect.left,
            y: touchEvent.touches[0].clientY - rect.top
        };
      }

      var save_fuction = () => this.save(image_path, id_obs, tipo_evidencia, id_fila);
      var load_fuction = (event) => this.load(event);

      saveButton.addEventListener('click', save_fuction, true);
      loadInput.addEventListener('change', load_fuction, true);   

      //si se cierra el modal se liberan los listener     
      $("[id^=uploadModal]").on('hidden.bs.modal', function () {
        $(this).data('bs.modal', null);
        saveButton.removeEventListener('click', save_fuction,true);
        loadInput.removeEventListener('change', load_fuction,true);
        circles = [];
        //console.log("modal borrado");
      });

      this.canvas = canvas;
      this.context = this.canvas.getContext('2d');
      
      this.loadTheImage(image_path);
    }
    startDrawing() {
      this.isDrawing = true; 
      startX=parseInt(event.pageX-offsetLeft);
      startY=parseInt(event.pageY-offsetTop - scroll_y); 
      circle = new Circle(startX, startY);
      circles.push(circle);   
    }
    stopDrawing() {
      this.isDrawing = false;      
      if(!puede_dibujar_a_mano){
        context_circle = this.context;
        circles.forEach(function(circ) {            
          circ.draw(context_circle);
        }); 
      }
    }
    draw(event, canvas_num, image_path) { 
      this.resize(canvas_num);
      if(puede_dibujar == true){
        if (this.isDrawing) {
          this.context.fillStyle = 'red';          
          //console.log(event.pageX + " " + event.pageY + " " +offsetLeft + " " + offsetTop);
          
          if(puede_dibujar_a_mano){
            this.context.fillRect(event.pageX - offsetLeft, event.pageY - offsetTop - scroll_y, 4, 4);
          }
          else{
            circle.radius = this.getDistance(startX, startY, event.pageX - offsetLeft, event.pageY - offsetTop  - scroll_y);
            
            this.context.clearRect(0, 0,this.canvas.width, this.canvas.height);          
            context_circle = this.context;
            circles.forEach(function(circ) {
              this.loadTheImage(image_path); 
              context_circle.beginPath();
              context_circle.arc(circ.startX, circ.startY, circ.radius, 0, 2 * Math.PI);
              context_circle.strokeStyle = "#f00";
              context_circle.lineWidth = 4;
              context_circle.stroke();           
              //circ.draw( this.context);
            }, this);
          }

        }
      }
    }
    getDistance(p1X, p1Y, p2X, p2Y) {
      return Math.sqrt(Math.pow(p1X - p2X, 2) + Math.pow(p1Y - p2Y, 2))
    }
    
    save(image_path, id_obs, tipo_evidencia, id_fila) {
      const data = this.canvas.toDataURL('image/png');
      //console.log(tipo_evidencia);
      if(tipo_evidencia == "evidencia" && evidencia_flag == true){      
        evidencia_flag = false;
        evidencia_src = data;
        close_snapshot();
        $('#myModalCamera').modal('toggle');
        document.getElementById(id_fila).innerHTML = '<img src="'+evidencia_src+'" style="width:100px;height:100px;"><br><br>';
      }
      //Si es una observacion tomada con cámara
      else if(tipo_evidencia == "evidencia_correctiva" && correctiva_flag == true){
        correctiva_flag = false;
        correctiva_src = data;
        close_snapshot();
        $('#myModalCamera').modal('toggle');
        document.getElementById(id_fila).innerHTML = '<img src="'+correctiva_src+'" style="width:100px;height:100px;"><br><br>';
      }
      //Agregar foto
      else if(tipo_evidencia == "check_list" && check_list_flag == true){
        check_list_flag = false;
        check_list_src = data;
        close_snapshot();
        $('#myModalCamera').modal('toggle');
        document.getElementById(id_fila).innerHTML = '<img src="'+check_list_src+'" style="width:100px;height:100px;"><br><br>';
      }
      //Agregar foto
      else if(tipo_evidencia == "fatiga" && fatiga_flag == true){
        fatiga_flag = false;
        fatiga_src = data;
        close_snapshot();
        $('#myModalCamera').modal('toggle');
        document.getElementById(id_fila).innerHTML = '<img src="'+fatiga_src+'" style="width:100px;height:100px;"><br><br>';
      }
      //Agregar foto
      else if(tipo_evidencia == "declaracion" && declaracion_flag == true){
        declaracion_flag = false;
        declaracion_src = data;
        close_snapshot();
        $('#myModalCamera').modal('toggle');
        document.getElementById(id_fila).innerHTML = '<img src="'+declaracion_src+'" style="width:100px;height:100px;"><br><br>';
      }
      //Agregar foto
      else if(tipo_evidencia == "iperc" && iperc_flag == true){
        iperc_flag = false;
        iperc_src = data;
        close_snapshot();
        $('#myModalCamera').modal('toggle');
        document.getElementById(id_fila).innerHTML = '<img src="'+iperc_src+'" style="width:100px;height:100px;"><br><br>';
      }
    }

    load(event) {
      const file = [...event.target.files].pop();
      this.readTheFile(file).then((image) => this.loadTheImage(image))
    }
    loadTheImage(image) {
      img = new Image();
      const canvas = this.canvas;
      img.onload = function () {
        const context = canvas.getContext('2d');
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.drawImage(img, 0, 0);        
      };
      img.src = image;
      if(img.height == 0){
        this.context.canvas.width = camera_width;
        this.context.canvas.height = camera_height;
      }else{
        this.context.canvas.height = img.height;
        this.context.canvas.width = img.width;
      }
      //$('.modal-content').css({width:img.width+100}); 
      //console.log("imagen cargada");
          
    }
    resize(canvas_num){
      rect = $("#canvas" + canvas_num)[0].getBoundingClientRect();
      offsetLeft = rect.left ;
      offsetTop = rect.top ;
    }  
    
    readTheFile(file) {
      const reader = new FileReader();
      return new Promise((resolve) => {
        reader.onload = (event) => {
          resolve(event.target.result);
        };
        reader.readAsDataURL(file);
      })
    }
  } 

  function Circle(startX, startY) {
    this.startX = startX;
    this.startY = startY;
    this.radius;
    this.draw = function(context) {      
      context.beginPath();
      context.arc(this.startX, this.startY, this.radius, 0, 2 * Math.PI);
      context.strokeStyle = "#f00";
      context.lineWidth = 4;
      context.stroke();
    }
  }
</script>

{% endblock %}